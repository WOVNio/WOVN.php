machine:
  pre:
    # https://discuss.circleci.com/t/docker-1-10-0-is-available-beta/2100
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    - sudo pip install docker-compose
  services:
    - docker

test:
  override:
    - vendor/bin/phpunit
    - vendor/bin/dunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.3 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.3 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.4 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.4 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.5 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.5 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.6 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:5.6 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source vectorface/hhvm /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source vectorface/hhvm /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:7.0 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:7.0 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:7.1 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:7.1 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:7.2 /bin/bash -c /opt/source/vendor/bin/phpunit
    - docker run -t -v $(pwd):/opt/source -w /opt/source php:7.2 /bin/bash -c 'a=$(find /opt/source -type f -name "*.php" !  -path "*/vendor/*" -print0 | xargs -0 -n 1 -P 8 php -l | grep -v "No syntax errors" | wc -l) && exit $a'
